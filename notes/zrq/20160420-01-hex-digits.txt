#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2016, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#  
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

# -------------------------------------------------------------------------------------------
# Create our 'waitlog' function.
#[user@desktop]

waitlog()
    {
    local name=${1:?Name required}
    local text=${2:?Text required}
    sed -r '/'${text}'/q' <( exec docker logs --follow "${name}" ); kill $! 2> /dev/null
    }

# -------------------------------------------------------------------------------------------
# Test our PostgreSQL container.
#[user@desktop]

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker
        
            datadir=$(mktemp -d)
            cp "pgsql/sql/alpha-source.sql" "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql" "${datadir}/02-data.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/pgsql:9.4-1.0"

            waitlog 'albert' '^Init'

            sleep 10

            docker exec \
                --tty \
                --interactive \
                'albert' \
                pgsql-client

                    \pset pager off

                    SELECT version() ;
                    -- PostgreSQL 9.4.7 on x86_64-redhat-linux-gnu, compiled by gcc (GCC) 5.3.1 20151207 (Red Hat 5.3.1-2), 64-bit

                    --
                    -- Numeric literal - FAIL
                    -- Interpreted as the numeric literal zero,
                    -- in a columns named xFF, x41 and xAA.
                    -- SELECT 0xFF ; -- 0
                    -- SELECT 0x41 ; -- 0
                    -- SELECT 0xAA ; -- 0

                    --
                    -- String literal plus - FAIL
                    -- Type missmatch between string and int.
                    -- SELECT x'FF' + 0 ;
                    -- SELECT x'41' + 0 ;
                    -- SELECT x'AA' + 0 ;

                    --
                    -- Explicit type cast to int - pass
                    SELECT x'FF'::int ; -- 255
                    SELECT x'41'::int ; --  65
                    SELECT x'AA'::int ; -- 170

                    --
                    -- Bit NOT - pass (signed int)
                    SELECT ~ x'FF'::int ; -- -256
                    SELECT ~ x'41'::int ; --  -66
                    SELECT ~ x'AA'::int ; -- -171

                    --
                    -- Bit AND - pass
                    SELECT x'FF'::int & x'AA'::int ; -- 170
                    SELECT x'41'::int & x'AA'::int ; --  0
                    SELECT x'AA'::int & x'AA'::int ; -- 170

                    --
                    -- Bit OR - pass
                    SELECT x'FF'::int | x'AA'::int ; -- 255
                    SELECT x'41'::int | x'AA'::int ; -- 235
                    SELECT x'AA'::int | x'AA'::int ; -- 170

                    --
                    -- Bit XOR - pass
                    SELECT x'FF'::int # x'AA'::int ; --  85
                    SELECT x'41'::int # x'AA'::int ; -- 235
                    SELECT x'AA'::int # x'AA'::int ; --   0

                    --
                    -- Sampling based on id.
                    SELECT id FROM alpha_source WHERE (id & x'0F'::int) = 0  ; --  2 rows
                    SELECT id FROM alpha_source WHERE (id & x'07'::int) = 0  ; --  5 rows
                    SELECT id FROM alpha_source WHERE (id & x'03'::int) = 0  ; -- 11 rows

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

                \q

        popd
    popd

# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')

# -------------------------------------------------------------------------------------------
# Test our MySQL container.
#[user@desktop]

    #
    # MySQL reference manual
    # 10.1.4 Hexadecimal Literals
    # https://dev.mysql.com/doc/refman/5.7/en/hexadecimal-literals.html

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker
        
            datadir=$(mktemp -d)
            cp "mysql/sql/alpha-source.sql" "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql" "${datadir}/02-data.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/mysql:5.6-1.0"

            waitlog 'albert' '^Init'

            sleep 10

            docker exec \
                --tty \
                --interactive \
                'albert' \
                mysql-client

                    select version();
                    -- 5.6.29

                    --
                    -- String literal - FAIL
                    -- Interpreted as the character literal,
                    -- in a columns named x'FF', x'41' and x'AA'.
                    -- SELECT x'FF' ; -- �
                    -- SELECT X'41' ; -- A
                    -- SELECT x'AA' ; -- �

                    --
                    -- Numeric literal - FAIL
                    -- Interpreted as the char value in
                    -- columns named 0xFF, 0x41 and 0xAA.
                    -- SELECT 0xFF  ; -- �
                    -- SELECT 0x41  ; -- A
                    -- SELECT 0xAA  ; -- �

                    --
                    -- Upper case 'X' rejected - FAIL
                    -- SELECT 0XFF  ;
                    -- SELECT 0X41  ;
                    -- SELECT 0XAA  ;

                    --
                    -- String literal plus - pass
                    -- Different MySQL:MariaDB
                    SELECT x'FF' + 0 ; -- 255
                    SELECT x'41' + 0 ; --  65
                    SELECT X'AA' + 0 ; -- 170

                    --
                    -- Numeric literal plus - pass
                    SELECT 0xFF  + 0 ; -- 255
                    SELECT 0x41  + 0 ; --  65
                    SELECT 0xAA  + 0 ; -- 170

                    --
                    -- CAST string literal - pass
                    -- Different MySQL:MariaDB
                    SELECT CAST(x'FF' AS SIGNED) ; -- 255
                    SELECT CAST(x'41' AS SIGNED) ; --  65
                    SELECT CAST(x'AA' AS SIGNED) ; -- 170

                    --
                    -- CAST string literal - pass
                    -- Different MySQL:MariaDB
                    SELECT CAST(x'FF' AS UNSIGNED) ; -- 255
                    SELECT CAST(X'41' AS UNSIGNED) ; --  65
                    SELECT CAST(x'AA' AS UNSIGNED) ; -- 170

                    --
                    -- CAST string literal - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT CAST(x'FF' AS INTEGER) ; -- 255
                    -- SELECT CAST(X'41' AS INTEGER) ; --  65
                    -- SELECT CAST(x'AA' AS INTEGER) ; -- 170

                    --
                    -- CAST numeric literal - pass
                    SELECT CAST(0xFF AS SIGNED) ; -- 255
                    SELECT CAST(0x41 AS SIGNED) ; --  65
                    SELECT CAST(0xAA AS SIGNED) ; -- 170

                    --
                    -- CAST numeric literal - pass
                    SELECT CAST(0xFF AS UNSIGNED) ; -- 255
                    SELECT CAST(0x41 AS UNSIGNED) ; --  65
                    SELECT CAST(0xAA AS UNSIGNED) ; -- 170

                    --
                    -- CAST numeric literal - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT CAST(0xFF AS INTEGER) ;
                    -- SELECT CAST(0x41 AS INTEGER) ;
                    -- SELECT CAST(0xAA AS INTEGER) ;

                    --
                    -- Bit NOT - pass (64bit unsigned)
                    -- Different MySQL:MariaDB
                    SELECT ~ x'FF' ; -- 18446744073709551360
                    SELECT ~ x'41' ; -- 18446744073709551550
                    SELECT ~ x'AA' ; -- 18446744073709551445

                    --
                    -- Bit NOT - pass (64bit unsigned)
                    SELECT ~ 0xFF ; -- 18446744073709551360
                    SELECT ~ 0x41 ; -- 18446744073709551550
                    SELECT ~ 0xAA ; -- 18446744073709551445

                    --
                    -- Bit AND - pass
                    -- Different MySQL:MariaDB
                    SELECT x'FF' & x'AA' ; -- 170
                    SELECT x'41' & x'AA' ; --   0
                    SELECT x'AA' & x'AA' ; -- 170

                    --
                    -- Bit AND - pass
                    SELECT 0xFF & 0xAA ; -- 170
                    SELECT 0x41 & 0xAA ; --   0
                    SELECT 0xAA & 0xAA ; -- 170

                    --
                    -- Bit OR - pass
                    -- Different MySQL:MariaDB
                    SELECT x'FF' | x'AA' ; -- 255
                    SELECT x'41' | x'AA' ; -- 235
                    SELECT x'AA' | x'AA' ; -- 170

                    --
                    -- Bit OR - pass
                    SELECT 0xFF | 0xAA ; -- 255
                    SELECT 0x41 | 0xAA ; -- 235
                    SELECT 0xAA | 0xAA ; -- 170

                    --
                    -- Bit XOR - pass
                    -- Different MySQL:MariaDB
                    SELECT x'FF' ^ x'AA' ; --  85
                    SELECT x'41' ^ x'AA' ; -- 235
                    SELECT x'AA' ^ x'AA' ; --   0

                    --
                    -- Bit XOR - pass
                    SELECT 0xFF ^ 0xAA ; --  85
                    SELECT 0x41 ^ 0xAA ; -- 235
                    SELECT 0xAA ^ 0xAA ; --   0

                    --
                    -- Sampling based on id - pass
                    SELECT id FROM alpha_source WHERE (id & x'0F') = 0  ; --  2 rows
                    SELECT id FROM alpha_source WHERE (id & x'07') = 0  ; --  5 rows
                    SELECT id FROM alpha_source WHERE (id & x'03') = 0  ; -- 11 rows

                    --
                    -- Sampling based on id - pass
                    SELECT id FROM alpha_source WHERE (id & 0x0F) = 0  ; --  2 rows
                    SELECT id FROM alpha_source WHERE (id & 0x07) = 0  ; --  5 rows
                    SELECT id FROM alpha_source WHERE (id & 0x03) = 0  ; -- 11 rows

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

                \q

        popd
    popd

# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')
        
# -------------------------------------------------------------------------------------------
# Test our MariaDB container.
#[user@desktop]

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker
        
            datadir=$(mktemp -d)
            cp "mariadb/sql/alpha-source.sql" "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql"   "${datadir}/02-data.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/mariadb:10.0-1.0"

            waitlog 'albert' '^Init'

            sleep 10
            
            docker exec \
                --tty \
                --interactive \
                'albert' \
                mysql-client

                    select version();
                    -- 10.0.23-MariaDB

                    --
                    -- String literal - FAIL
                    -- Interpreted as the character literal,
                    -- in a columns named x'FF', x'41' and x'AA'.
                    -- SELECT x'FF' ; -- �
                    -- SELECT X'41' ; -- A
                    -- SELECT x'AA' ; -- �

                    --
                    -- Numeric literal - FAIL
                    -- Interpreted as the char value in
                    -- columns named 0xFF, 0x41 and 0xAA.
                    -- SELECT 0xFF  ; -- �
                    -- SELECT 0x41  ; -- A
                    -- SELECT 0xAA  ; -- �

                    --
                    -- Upper case 'X' rejected - FAIL
                    -- SELECT 0XFF  ;
                    -- SELECT 0X41  ;
                    -- SELECT 0XAA  ;

                    --
                    -- String literal plus - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT x'FF' + 0 ; -- 0
                    -- SELECT X'41' + 0 ; -- 0
                    -- SELECT X'AA' + 0 ; -- 0
                    -- 1 row in set, 1 warning (0.00 sec)

                    --
                    -- Numeric literal plus - pass
                    SELECT 0xFF  + 0 ; -- 255
                    SELECT 0x41  + 0 ; --  65
                    SELECT 0xAA  + 0 ; -- 170

                    -- CAST string literal - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT CAST(x'FF' AS INTEGER) ; -- 0
                    -- SELECT CAST(X'41' AS INTEGER) ; -- 0
                    -- SELECT CAST(x'AA' AS INTEGER) ; -- 0
                    -- 1 row in set, 1 warning (0.00 sec)

                    --
                    -- CAST string literal - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT CAST(x'FF' AS SIGNED) ; -- 0
                    -- SELECT CAST(X'41' AS SIGNED) ; -- 0
                    -- SELECT CAST(x'AA' AS SIGNED) ; -- 0
                    -- 1 row in set, 1 warning (0.00 sec)

                    --
                    -- CAST string literal - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT CAST(x'FF' AS UNSIGNED) ; -- 0
                    -- SELECT CAST(X'41' AS UNSIGNED) ; -- 0
                    -- SELECT CAST(x'AA' AS UNSIGNED) ; -- 0
                    -- 1 row in set, 1 warning (0.00 sec)

                    --
                    -- CAST numeric literal - pass
                    SELECT CAST(0xFF AS SIGNED) ; -- 255
                    SELECT CAST(0x41 AS SIGNED) ; --  65
                    SELECT CAST(0xAA AS SIGNED) ; -- 170

                    --
                    -- CAST numeric literal - pass
                    SELECT CAST(0xFF AS UNSIGNED) ; -- 255
                    SELECT CAST(0x41 AS UNSIGNED) ; --  65
                    SELECT CAST(0xAA AS UNSIGNED) ; -- 170

                    --
                    -- CAST numeric literal - pass
                    -- Different MySQL:MariaDB
                    SELECT CAST(0xFF AS INTEGER) ; -- 255
                    SELECT CAST(0x41 AS INTEGER) ; --  65
                    SELECT CAST(0xAA AS INTEGER) ; -- 170

                    --
                    -- Bit NOT - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT ~ x'FF' ; -- 18446744073709551615
                    -- SELECT ~ x'41' ; -- 18446744073709551615
                    -- SELECT ~ x'AA' ; -- 18446744073709551615
                    -- 1 row in set, 1 warning (0.00 sec)

                    --
                    -- Bit NOT - pass (64bit unsigned)
                    SELECT ~ 0xFF ; -- 18446744073709551360
                    SELECT ~ 0x41 ; -- 18446744073709551550
                    SELECT ~ 0xAA ; -- 18446744073709551445

                    --
                    -- Bit AND - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT x'FF' & x'AA' ; -- 0
                    -- SELECT x'41' & x'AA' ; -- 0
                    -- SELECT x'AA' & x'AA' ; -- 0
                    -- 1 row in set, 2 warnings (0.00 sec)

                    --
                    -- Bit AND - pass
                    SELECT 0xFF & 0xAA ; -- 170
                    SELECT 0x41 & 0xAA ; --   0
                    SELECT 0xAA & 0xAA ; -- 170

                    --
                    -- Bit OR - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT x'FF' | x'AA' ; -- 0
                    -- SELECT x'41' | x'AA' ; -- 0
                    -- SELECT x'AA' | x'AA' ; -- 0
                    -- 1 row in set, 2 warnings (0.00 sec)

                    --
                    -- Bit OR - pass
                    SELECT 0xFF | 0xAA ; -- 255
                    SELECT 0x41 | 0xAA ; -- 235
                    SELECT 0xAA | 0xAA ; -- 170

                    --
                    -- Bit XOR - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT x'FF' ^ x'AA' ; -- 0
                    -- SELECT x'41' ^ x'AA' ; -- 0
                    -- SELECT x'AA' ^ x'AA' ; -- 0
                    -- 1 row in set, 2 warnings (0.00 sec)

                    --
                    -- Bit XOR - pass
                    SELECT 0xFF ^ 0xAA ; --  85
                    SELECT 0x41 ^ 0xAA ; -- 235
                    SELECT 0xAA ^ 0xAA ; --   0

                    --
                    -- Sampling based on id - FAIL
                    -- Different MySQL:MariaDB
                    -- SELECT id FROM alpha_source WHERE (id & x'0F') = 0  ; -- 46 rows
                    -- SELECT id FROM alpha_source WHERE (id & x'07') = 0  ; -- 46 rows
                    -- SELECT id FROM alpha_source WHERE (id & x'03') = 0  ; -- 46 rows
                    46 rows in set, 46 warnings (0.00 sec)

                    --
                    -- Sampling based on id - pass
                    SELECT id FROM alpha_source WHERE (id & 0x0F) = 0  ; --  2 rows
                    SELECT id FROM alpha_source WHERE (id & 0x07) = 0  ; --  5 rows
                    SELECT id FROM alpha_source WHERE (id & 0x03) = 0  ; -- 11 rows

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

            \q

        popd
    popd

# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')

# -------------------------------------------------------------------------------------------
# Test our Derby container.
#[user@desktop]

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker
        
            datadir=$(mktemp -d)
            cp "derby/sql/alpha-source.sql" "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql" "${datadir}/02-data.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/derby:10.12-1.0"

            waitlog 'albert' '^Init'

            sleep 10

            docker exec \
                --tty \
                --interactive \
                'albert' \
                derby-client

                --
                -- No support for bitwise operators or hexadecimal numbers.
                -- 

                --
                -- http://stackoverflow.com/questions/11101333/bitwise-operator-in-apache-derby
                -- http://wiki.apache.org/db-derby/DerbySQLroutines
                -- https://code.google.com/archive/p/apache-derby-functions/downloads
                -- TODO - Create our own Java library for Derby.
                --

            quit;

        popd
    popd

# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')

# -------------------------------------------------------------------------------------------
# Test our HyperSQL container.
#[user@desktop]

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker
        
            datadir=$(mktemp -d)
            cp "hsqldb/sql/alpha-source.sql" "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql"  "${datadir}/02-data.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/hsqldb:2.3-1.0"

            waitlog 'albert' '^Init'

            sleep 10

            docker exec \
                --tty \
                --interactive \
                'albert' \
                hsqldb-client

                    --
                    -- Query without FROM is not supported.
                    -- SELECT 65 ;

                    --
                    -- Decimal literal - pass
                    SELECT 65 FROM alpha_source LIMIT 1 ;

                    --
                    -- Numeric literal - FAIL
                    -- SELECT 0xFF FROM alpha_source LIMIT 1 ; -- 0

                    --
                    -- String literal - FAIL
                    -- SELECT x'FF' FROM alpha_source LIMIT 1 ; -- ff

                    --
                    -- String literal plus - FAIL
                    -- SELECT x'FF' + 0 FROM alpha_source LIMIT 1 ;
                    -- SELECT 255   + 0 FROM alpha_source LIMIT 1 ;

                    --
                    -- HEXTORAW - FAIL
                    -- SELECT HEXTORAW('FF') FROM alpha_source LIMIT 1 ; -- ff

                    --
                    -- CAST - FAIL
                    SELECT CAST('FF' AS INTEGER) FROM alpha_source LIMIT 1 ;
                    SELECT CAST('0FF' AS INTEGER) FROM alpha_source LIMIT 1 ;
                    SELECT CAST(x'FF' AS INTEGER) FROM alpha_source LIMIT 1 ;
                    SELECT CAST('xFF' AS INTEGER) FROM alpha_source LIMIT 1 ;
                    SELECT CAST('0FF' AS INTEGER) FROM alpha_source LIMIT 1 ;
                    SELECT CAST('0xFF' AS INTEGER) FROM alpha_source LIMIT 1 ;

                    --
                    -- Java Integer.decode - pass
                    SELECT "java.lang.Integer.decode"('0xFF') FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Integer.decode"('0x41') FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Integer.decode"('0xAA') FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Java Long.decode - pass
                    SELECT "java.lang.Integer.decode"('#FF') FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Integer.decode"('#41') FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Integer.decode"('#AA') FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Java Integer.parseInt - pass
                    SELECT "java.lang.Integer.parseInt"('FF', 16) FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Integer.parseInt"('41', 16) FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Integer.parseInt"('AA', 16) FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Java Long.parseLong - pass
                    SELECT "java.lang.Long.parseLong"('FF', 16) FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Long.parseLong"('41', 16) FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Long.parseLong"('AA', 16) FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Java Long.decode - pass
                    SELECT "java.lang.Long.decode"('0xFF') FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Long.decode"('0x41') FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Long.decode"('0xAA') FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Java Long.decode - pass
                    SELECT "java.lang.Long.decode"('#FF') FROM alpha_source LIMIT 1 ; -- 255
                    SELECT "java.lang.Long.decode"('#41') FROM alpha_source LIMIT 1 ; --  65
                    SELECT "java.lang.Long.decode"('#AA') FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Bit NOT (signed int) - pass
                    SELECT BITNOT("java.lang.Integer.decode"('0xFF')) FROM alpha_source LIMIT 1 ; -- -256
                    SELECT BITNOT("java.lang.Integer.decode"('0x41')) FROM alpha_source LIMIT 1 ; --  -66
                    SELECT BITNOT("java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- -171

                    --
                    -- Bit AND - pass
                    SELECT BITAND("java.lang.Integer.decode"('0xFF'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 170
                    SELECT BITAND("java.lang.Integer.decode"('0x41'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; --   0
                    SELECT BITAND("java.lang.Integer.decode"('0xAA'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Bit OR - pass
                    SELECT BITOR("java.lang.Integer.decode"('0xFF'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 255
                    SELECT BITOR("java.lang.Integer.decode"('0x41'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 235
                    SELECT BITOR("java.lang.Integer.decode"('0xAA'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 170

                    --
                    -- Bit OR - pass
                    SELECT BITXOR("java.lang.Integer.decode"('0xFF'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; --  85
                    SELECT BITXOR("java.lang.Integer.decode"('0x41'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; -- 235
                    SELECT BITXOR("java.lang.Integer.decode"('0xAA'), "java.lang.Integer.decode"('0xAA')) FROM alpha_source LIMIT 1 ; --   0

                    --
                    -- Sampling based on id - FAIL 
                    SELECT id FROM alpha_source WHERE BITAND(id, 15) = 0  ; --  3 rows FAIL
                    SELECT id FROM alpha_source WHERE BITAND(id,  7) = 0  ; --  6 rows FAIL
                    SELECT id FROM alpha_source WHERE BITAND(id,  3) = 0  ; -- 12 rows FAIL

                    --
                    -- Sampling based on id (zero base fix) - pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1), 15) = 0  ; --  2 rows pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1),  7) = 0  ; --  5 rows pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1),  3) = 0  ; -- 11 rows pass

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

                    --
                    -- Sampling based on id - FAIL
                    SELECT id FROM alpha_source WHERE BITAND(id, "java.lang.Integer.decode"('0x0F')) = 0  ; --  3 rows FAIL
                    SELECT id FROM alpha_source WHERE BITAND(id, "java.lang.Integer.decode"('0x07')) = 0  ; --  6 rows FAIL
                    SELECT id FROM alpha_source WHERE BITAND(id, "java.lang.Integer.decode"('0x03')) = 0  ; -- 12 rows FAIL

                    --
                    -- Sampling based on id (zero base fix) - pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1), "java.lang.Integer.decode"('0x0F')) = 0  ; --  2 rows pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1), "java.lang.Integer.decode"('0x07')) = 0  ; --  5 rows pass
                    SELECT (id + 1) FROM alpha_source WHERE BITAND((id + 1), "java.lang.Integer.decode"('0x03')) = 0  ; -- 11 rows pass

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

            \q

        popd
    popd

# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')

# -------------------------------------------------------------------------------------------
# Download our Oracle RPM file.
#[user@desktop]

    #
    # Download the zipfile from Oracle.
    # http://www.oracle.com/technetwork/database/database-technologies/express-edition/downloads/index.html

    version=11.2.0-1.0
    rpmfile=oracle-xe-${version}.x86_64.rpm
    zipfile=${rpmfile}.zip
    tarfile=${rpmfile}.tar.gz

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        if [ ! -e 'binaries/oracle' ]
        then
            mkdir -p 'binaries/oracle'
        fi

        pushd binaries
            pushd oracle
                if [ ! -e "${tarfile}" ]
                then
                    if [ ! -e "${rpmfile}" ]
                    then
                        if [ -e "${zipfile}" ]
                        then
                            unzip -j "${zipfile}" '*.rpm'
                        fi
                    fi
                    if [ -e "${rpmfile}" ]
                    then
                        tar -cvzf "${tarfile}" \
                            "${rpmfile}"
                    fi
                fi
            popd
        popd

        if [ ! -e "binaries/oracle/${tarfile}" ]
        then
            echo ""
            echo "-------- --------"
            echo "Please download the Oracle-Xe (eXpress Edition) zipfile"
            echo "Source [http://www.oracle.com/technetwork/database/database-technologies/express-edition/downloads/index.html]"
            echo "Target [$(pwd)]"
            echo "-------- --------"
            echo ""
        fi

        pushd docker
            pushd oracle/oracle-xe/11.2
                if [ ! -d 'rpm' ]
                then
                    mkdir 'rpm'
                fi
                pushd rpm
                    if [ ! -e "${tarfile}" ]
                    then
                        ln "${COSMOPTERIX_CODE:?}/binaries/oracle/${tarfile}" "${tarfile}"
                    fi
                popd
            popd
        popd
    popd

# -----------------------------------------------------
# Build our Oracle containers.
#[user@desktop]

    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker

            docker build \
                --tag "cosmopterix/oracle-linux:7.2-1.0" \
                oracle/oracle-linux/7.2
            
            docker build \
                --tag "cosmopterix/oracle-xe:11.2-1.0" \
                oracle/oracle-xe/11.2
    
        popd
    popd

    #
    # From MadHead (https://github.com/madhead/docker-oracle-xe)
    # During the configuration of Oracle XE instance two files - init.ora and initXETemp.ora -
    # are overridden with ones from config directory of this repo.
    # The only difference is that memory_target parameter is commented in them to prevent
    # ORA-00845: MEMORY_TARGET not supported on this system error.
    # The only piece of magic in this image :).
    #

    #
    # TODO - Move the create database step from the build time to run time.
    # TODO - Move the database files in a volume.
    # TODO - Configure database using config scripts.

# -------------------------------------------------------------------------------------------
# Run our Oracle container.
#[user@desktop]


    source "${HOME:?}/cosmopterix.settings"
    pushd "${COSMOPTERIX_CODE:?}"

        pushd docker

            datadir=$(mktemp -d)
            cp "oracle/oracle-xe/11.2/sql/alpha-source.sql"  "${datadir}/01-alpha.sql"
            cp "data/alpha-source-data.sql"                  "${datadir}/02-data.sql"
            cp "oracle/oracle-xe/11.2/sql/bit-functions.sql" "${datadir}/03-bits.sql"

            docker run \
                --detach \
                --name 'albert' \
                --volume "${datadir}:/database.init/" \
                "cosmopterix/oracle-xe:11.2-1.0"

            docker logs -f 'albert'

                Thu Apr 28 10:52:43 UTC 2016
                Starting Oracle Net Listener.
                Starting Oracle Database 11g Express Edition instance.

            docker exec \
                --tty \
                --interactive \
                'albert' \
                sqlplus

                    -- Enter user-name: system
                    -- Enter password: oracle

                    -- Connected to:
                    -- Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production
                    -- SQL> 

                    START /database.init/01-alpha.sql

                        Table created.
                        Sequence created.
                        Trigger created.

                    START /database.init/02-data.sql

                        1 row created.
                        1 row created.
                        ....
                        ....
                        1 row created.

                    --
                    -- Pagination using ROWNUM.
                    -- http://www.oracle.com/technetwork/issue-archive/2006/06-sep/o56asktom-086197.html
                    SELECT
                        id, ra, decl
                    FROM
                        (
                        SELECT
                            id, ra, decl, ROWNUM as rn
                        FROM
                            alpha_source
                        )
                    WHERE rn > 10 AND rn <= 20
                    ;

                    --
                    -- Hexadecimal Constants in Oracle
                    -- http://stackoverflow.com/a/1227073
                    -- http://www.sqlines.com/oracle/hex_constants
                    SELECT TO_NUMBER('FF', 'xx') FROM alpha_source WHERE id = 1 ;
                    SELECT TO_NUMBER('41', 'xx') FROM alpha_source WHERE id = 1 ;
                    SELECT TO_NUMBER('AA', 'xx') FROM alpha_source WHERE id = 1 ;

                    --
                    -- Number of 'x''s must be >= number of digits.
                    -- SELECT TO_NUMBER('AA', 'x') FROM alpha_source WHERE id = 1 ; -- [ORA-01722: invalid number]
                    SELECT TO_NUMBER('AA', 'xx') FROM alpha_source WHERE id = 1 ;
                    SELECT TO_NUMBER('AA', 'xxx') FROM alpha_source WHERE id = 1 ;
                    SELECT TO_NUMBER('AA', 'xxxx') FROM alpha_source WHERE id = 1 ;

--
-- User defined functions.
-- https://community.oracle.com/thread/498773

                    START /database.init/03-bits.sql

                    --
                    -- Bit NOT - pass (signed int)
                    SELECT BITNOT(TO_NUMBER('FF', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- -256
                    SELECT BITNOT(TO_NUMBER('41', 'xxxx')) FROM alpha_source WHERE id = 1 ; --  -66
                    SELECT BITNOT(TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- -171

                    --
                    -- Bit AND - pass
                    SELECT BITAND(TO_NUMBER('FF', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 170
                    SELECT BITAND(TO_NUMBER('41', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; --   0
                    SELECT BITAND(TO_NUMBER('AA', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 170

                    --
                    -- Bit OR - pass
                    SELECT BITOR(TO_NUMBER('FF', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 255
                    SELECT BITOR(TO_NUMBER('41', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 235
                    SELECT BITOR(TO_NUMBER('AA', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 170

                    --
                    -- Bit XOR - pass
                    SELECT BITXOR(TO_NUMBER('FF', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; --  85
                    SELECT BITXOR(TO_NUMBER('41', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; -- 235
                    SELECT BITXOR(TO_NUMBER('AA', 'xxxx'), TO_NUMBER('AA', 'xxxx')) FROM alpha_source WHERE id = 1 ; --   0

                    --
                    -- Sampling based on id - pass
                    SELECT id FROM alpha_source WHERE BITAND(id, TO_NUMBER('0F', 'xxxx')) = 0  ;
                    SELECT id FROM alpha_source WHERE BITAND(id, TO_NUMBER('07', 'xxxx')) = 0  ;
                    SELECT id FROM alpha_source WHERE BITAND(id, TO_NUMBER('03', 'xxxx')) = 0  ;

                        -- 16
                        -- 32

                        --  8
                        -- 16
                        -- 24
                        -- 32
                        -- 40

                        --  4
                        --  8
                        -- 12
                        -- 16
                        -- 20
                        -- 24
                        -- 28
                        -- 32
                        -- 36
                        -- 40
                        -- 44

                quit

        popd
    popd


# -------------------------------------------------------------------------------------------
# Remove the container
#[user@desktop]

    docker rm --volumes $(docker stop 'albert')

